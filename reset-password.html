<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reset Password â€” Rajneeti</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #f5f0eb;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 48px 40px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.10);
    }

    .logo {
      text-align: center;
      margin-bottom: 28px;
    }

    .logo h1 {
      font-size: 2rem;
      font-weight: 800;
      color: #1a1a1a;
      letter-spacing: -0.5px;
    }

    .logo span {
      color: #e05c1a;
    }

    h2 {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 6px;
    }

    .subtitle {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 28px;
    }

    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
    }

    .input-wrap {
      position: relative;
      margin-bottom: 16px;
    }

    input[type="password"] {
      width: 100%;
      padding: 12px 44px 12px 14px;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      color: #1a1a1a;
      background: #fafafa;
      transition: border-color 0.2s;
      outline: none;
    }

    input[type="password"]:focus {
      border-color: #e05c1a;
      background: #fff;
    }

    .toggle-pw {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #999;
      font-size: 1rem;
      padding: 0;
      line-height: 1;
    }

    .strength-bar {
      height: 4px;
      background: #eee;
      border-radius: 4px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .strength-fill {
      height: 100%;
      width: 0%;
      border-radius: 4px;
      transition: width 0.3s, background 0.3s;
    }

    .btn {
      width: 100%;
      padding: 13px;
      background: #e05c1a;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      letter-spacing: 0.3px;
    }

    .btn:hover { background: #c44e14; }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { background: #ccc; cursor: not-allowed; }

    .message {
      margin-top: 18px;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      display: none;
    }

    .message.success {
      background: #eafbf0;
      color: #1a7f47;
      border: 1px solid #b2e9cb;
    }

    .message.error {
      background: #fff0f0;
      color: #c0392b;
      border: 1px solid #f5b7b1;
    }

    .back-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      font-size: 0.88rem;
      color: #888;
      text-decoration: none;
    }

    .back-link:hover { color: #e05c1a; }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.5);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .token-error {
      text-align: center;
      padding: 32px 0 8px;
    }

    .token-error .icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
    }

    .token-error p {
      color: #555;
      font-size: 0.95rem;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">
      <h1>Raj<span>neeti</span></h1>
    </div>

    <!-- Token missing/invalid state -->
    <div id="tokenError" class="token-error" style="display:none;">
      <div class="icon">ğŸ”—</div>
      <h2>Invalid Reset Link</h2>
      <p>This password reset link is invalid or has already been used. Please request a new one.</p>
      <a href="/forgot-password.html" class="btn" style="display:inline-block;text-decoration:none;text-align:center;">Request New Link</a>
    </div>

    <!-- Reset form -->
    <div id="resetForm">
      <h2>Set New Password</h2>
      <p class="subtitle">Enter your new password below. Make it strong!</p>

      <label for="newPassword">New Password</label>
      <div class="input-wrap">
        <input type="password" id="newPassword" placeholder="Min. 8 characters" autocomplete="new-password" />
        <button class="toggle-pw" type="button" onclick="toggleVisibility('newPassword', this)" title="Show/hide">ğŸ‘</button>
      </div>
      <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>

      <label for="confirmPassword">Confirm Password</label>
      <div class="input-wrap">
        <input type="password" id="confirmPassword" placeholder="Repeat your password" autocomplete="new-password" />
        <button class="toggle-pw" type="button" onclick="toggleVisibility('confirmPassword', this)" title="Show/hide">ğŸ‘</button>
      </div>

      <button class="btn" id="submitBtn" onclick="handleReset()">Reset Password</button>

      <div class="message" id="statusMsg"></div>

      <a href="/" class="back-link">â† Back to home</a>
    </div>
  </div>

  <script>
    const API_BASE = "https://rajneeti-backend.onrender.com"; // â† update if needed

    // â”€â”€ Extract token from URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const params = new URLSearchParams(window.location.search);
    const token  = params.get("token");

    if (!token) {
      document.getElementById("resetForm").style.display  = "none";
      document.getElementById("tokenError").style.display = "block";
    }

    // â”€â”€ Password strength meter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("newPassword").addEventListener("input", function () {
      const val = this.value;
      const fill = document.getElementById("strengthFill");
      let score = 0;

      if (val.length >= 8) score++;
      if (/[A-Z]/.test(val))  score++;
      if (/[0-9]/.test(val))  score++;
      if (/[^A-Za-z0-9]/.test(val)) score++;

      const colours = ["#e74c3c", "#e67e22", "#f1c40f", "#2ecc71"];
      const widths  = ["25%", "50%", "75%", "100%"];

      fill.style.width      = score > 0 ? widths[score - 1] : "0%";
      fill.style.background = score > 0 ? colours[score - 1] : "transparent";
    });

    // â”€â”€ Toggle password visibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleVisibility(inputId, btn) {
      const input = document.getElementById(inputId);
      if (input.type === "password") {
        input.type = "text";
        btn.textContent = "ğŸ™ˆ";
      } else {
        input.type = "password";
        btn.textContent = "ğŸ‘";
      }
    }

    // â”€â”€ Show feedback message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showMessage(text, type) {
      const el = document.getElementById("statusMsg");
      el.textContent = text;
      el.className   = `message ${type}`;
      el.style.display = "block";
    }

    // â”€â”€ Main handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function handleReset() {
      const newPassword     = document.getElementById("newPassword").value.trim();
      const confirmPassword = document.getElementById("confirmPassword").value.trim();
      const btn             = document.getElementById("submitBtn");

      // Validation
      if (!newPassword || !confirmPassword) {
        return showMessage("Please fill in both fields.", "error");
      }

      if (newPassword.length < 8) {
        return showMessage("Password must be at least 8 characters.", "error");
      }

      if (newPassword !== confirmPassword) {
        return showMessage("Passwords do not match.", "error");
      }

      // Loading state
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Resettingâ€¦';

      try {
        const res = await fetch(`${API_BASE}/reset-password`, {
          method:  "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, new_password: newPassword })
        });

        const data = await res.json();

        if (res.ok) {
          showMessage("âœ… Password reset successful! Redirecting to loginâ€¦", "success");
          btn.style.display = "none";
          setTimeout(() => { window.location.href = "https://rajneeti-frontend.vercel.app?login=1"; }, 2500);
        } else {
          showMessage(data.detail || "Something went wrong. Please try again.", "error");
          btn.disabled = false;
          btn.textContent = "Reset Password";
        }

      } catch (err) {
        showMessage("Network error. Please check your connection.", "error");
        btn.disabled = false;
        btn.textContent = "Reset Password";
      }
    }

    // Allow Enter key to submit
    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter") handleReset();
    });
  </script>
</body>
</html>
